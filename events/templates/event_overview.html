{% extends "newBase.html" %}
{% load static %}
{% block title %}Event Overview{% endblock %}
{%block head%}

<script>
async function copyRSVPLink() {
    const button = document.getElementById('copyRSVPButton');
    const rsvpUrl = window.location.origin + '/events/{{event.id}}/rsvp/';
    
    try {
        await navigator.clipboard.writeText(rsvpUrl);
        
        // Update button text and style to show success
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>Copied!';
        button.classList.add('copied');
        
        // Re-initialize lucide icons for the new check icon
        lucide.createIcons();
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('copied');
            lucide.createIcons();
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy: ', err);
        
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = rsvpUrl;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            
            // Update button text to show success
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>Copied!';
            button.classList.add('copied');
            
            lucide.createIcons();
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('copied');
                lucide.createIcons();
            }, 2000);
            
        } catch (fallbackErr) {
            console.error('Fallback copy failed: ', fallbackErr);
            alert('Copy failed. Please manually copy the RSVP link: ' + rsvpUrl);
        }
        
        document.body.removeChild(textArea);
    }
}
</script>
{%endblock%}
{% block content %}
<main class="main-content">
  <div class="event-card">
    <div class="event-header">
        <div>
            <h2 class="event-title">{{event.event_name}}</h2>
            <div class="event-date">{{event.event_date|date:"F j, Y â€¢ g:i A"}} - {{event.end_time|date:"g:i A"}}</div>
        </div>
        <div class="event-actions">
            <a href="{% url 'event_editor_view' event_id=event.id %}" class="edit-button">
                <i data-lucide="edit" class="w-4 h-4"></i>
                Edit Event
            </a>
            <a href="{% url 'sign_in' event_id=event.id %}" class="sign-in-button">
                <i data-lucide="log-in" class="w-4 h-4"></i>
                Sign In
            </a>
            <button onclick="copyRSVPLink()" class="sign-in-button copy-rsvp-button" id="copyRSVPButton">
                <i data-lucide="copy" class="w-4 h-4"></i>
                Copy RSVP Link
            </button>
        </div>
    </div>
    
    <!-- Event Stats -->
    <div class="event-stats">
        <div class="stat-card">
            <div class="stat-value">{{event.get_attendance}}</div>
            <div class="stat-label">Members Present</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{event.get_attendance_rate|floatformat:2}}%</div>
            <div class="stat-label">Attendance Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{event.get_expected_attendees}}</div>
            <div class="stat-label">Expected Members</div>
        </div>
    </div>
    
    <!-- Current Attendance -->
    <h3 class="section-title">Current Attendance</h3>
    <div class="attendance-list">
        {% for attendance in event.get_attendees|slice:":4" %}
        <div class="attendance-item">
            <div class="attendance-info">
                <div class="status-dot"></div>
                <div>
                    <div>{{attendance.user.first_name}} {{attendance.user.last_name}}</div>
                    <div class="attendance-time">Signed in at {{attendance.timestamp|date:"g:i A"}}</div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="attendance-item">
            <div>No members have signed in yet.</div>
        </div>
        {% endfor %}
    </div>
</div>

<section>
  <h2 class="section-title">Demographics</h2>
  <div class="event-card">
    <div class="event-stats">
      <div class="stat-card">
        {% for major in event.get_event_major_breakdown %}
        <div class="stat-value">{{major.name}} - {{major.count}}</div>
        {% endfor %}
        <div class="stat-label">Major Breakdown</div>
      </div>
      <div class="stat-card">
        {% for gender in event.get_event_gender_breakdown %}
        <div class="stat-value">{{gender.name}} - {{gender.count}}</div>
        {% endfor %}
        <div class="stat-label">Gender Breakdown</div>
      </div>
      <div class="stat-card">
        {% for race in event.get_event_race_breakdown %}
        <div class="stat-value">{{race.name}} - {{race.count}}</div>
        {% endfor %}
        <div class="stat-label">Race Breakdown</div>
      </div>
</section>

<section>
  <h2>New Members</h2>
  {% for member in event.get_new_members %}
    <p>member.name</p>
  {% endfor %} 
</section>

</main>
{%endblock%}